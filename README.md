# PROJET DE-S8 : Malwares 

## Introduction

Au fil de ce projet, nous avons mis en pratique les compétences acquises en cours DE en vue de concevoir un projet qui puisse répondre à une problématique : l'analyse des malwares (sous Windows) et la visualisation de leur comportement.

Les principales technologies utilisées sont les suivantes :

| Nom | Logo |
| --- | --- |
| Pandas | <img src="assets/img/pandas.png" width="30%" alt="Pandas logo"> |
| BeautifulSoup | <img src="assets/img/beautifulSoup.png" alt="BeautifulSoup logo" width="30%" > |
| Selenium | <img src="assets/img/selenium.jpg" alt="Selenium logo" width="30%" > |

L'outil que nous avons développé permet de :

1. Géolocaliser les adresses IP avec lesquelles communique un malware et déterminer si elles passent par le réseau TOR.
2. Déterminer quelles sont les techniques utilisées par le malware.
3. Visualiser les fonctions et DLLs chargées par le malware.
4. Visualiser le taux de détection des antivirus du malware.
5. Et bien plus encore..!

Schéma général de fonctionnement :

<img width="50%" src="https://i.ibb.co/V2Pqxwz/Diagramme-vierge-8.png">

Schémas du processus d'extraction et de récolte des données :

<img src="https://i.ibb.co/mSQcHP5/Diagramme-Projet-DE-1.png" alt="extraction process diagram">

<img src="https://i.ibb.co/jh2S0d6/schema-idee-projet-2-1.png" alt="data collection scheme">

## Vidéo montrant le processus d'extraction, de parsing et de récole des données sur un processus Windows (Montrant les drivers Selenium lors du parsing de la Microsoft.com et geolocation.io)

[![Extractor & parsing in action](https://img.youtube.com/vi/QagDy882Ak0/0.jpg)](https://www.youtube.com/watch?v=QagDy882Ak0)


## Récupération des informations de détection Antivirus

Afin de pouvoir savoir quels sont les antivirus qui détectent notre processus comme étant malveillant ou non, nous utilisons l’API de VirusTotal à laquelle nous faisons une requête avec le processus en question et qui après un délai de traitement renvoie une suite de données dont un hash identifiant la signature du processus et le lien vers les informations de détection concernant ce processus. C’est ce lien retourné que nous interrongons par la suite en vue de parser et d’obtenir les noms d’éditeurs d’antivirus et leur état de détection.

On a également pu trouver une petite API sympathique qui renvoie le logo d’une entreprise si elle en trouve le site web.

```xml
<SecurityVendors>
	<Vendor>
		<Logo>https://api.kickfire.com/logo?website=Google.com</Logo>
		<Name>Google</Name>
		<Detected>No</Detected>
		<Update>20230517</Update>
	</Vendor>
	<Vendor>
		<Logo>https://api.kickfire.com/logo?website=APEX.com</Logo>
		<Name>APEX</Name>
		<Detected>Yes</Detected>
		<Update>20230516</Update>
	</Vendor>
```

## Récupération et géolocalisation des adresses IP contactées

L’extacteur se charge de lancer une capture de paquets IP sur les processus et les récolte jusqu’à atteindre un seul modulable de paquets. Il met en forme les paquets capturés dans un fichier CSV qui sera ensuite utilisé par le bloc de code responsable du parsing dynamique du site de géolocalisation IP [https://ipgeolocation.io/](https://ipgeolocation.io/) auquel il envoie une par une les adresses IP de destination et y récupère les données de géolocalisation (latitude, longitude, Pays, ISP).

Extrait de PacketCaptureDump.csv (généré à la fin de la capture): 
```csv
time,ip_version,src_ip,src_port,dst_ip,dst_port,ip_ttl,proto,ip_flags
12:48:15,4,192.168.1.22,35601,162.250.191.15,7777,128,6,0x40
12:48:15,4,192.168.1.22,35600,162.250.191.15,7777,128,6,0x40
12:48:15,4,192.168.1.22,35599,162.212.158.82,7777,128,6,0x40
```

## Détermination d'un passage sur le réseau TOR

Pour cette deuxième partie, nous avons dû étudié un <a href="[https://www.dan.me.uk/tornodes](https://www.dan.me.uk/tornodes)"> site référançant les nœuds du réseau TOR.</a>

Attention, l'administrateur du site ne tolère qu'une connexion toutes les 30 minutes.

Après son étude, nous avons procédé à son scrapping grâce à la libraire BeautifulSoup. Une fois fait, nous avons centralisé tous les nœuds du réseau TOR au sein d'un fichier CSV (<b>parser/GettingDarkWebIPs/dark_IPv4_addresses.csv</b>), plus maniable pour une utilisation future.

Extrait d'un snapshot des noeuds d'entrée TOR datant du 05/05/23:

```csv
1.33.33.5|5gnPr4VhxQm2zHcHQcm|443|0|FRDV|280448|Tor 0.4.7.13|Random Person <nobody AT example dot com>
100.19.145.164|TBB|443|0|FRDV|63|Tor 0.4.7.13|
100.2.45.164|hubble|9001|0|FGHRSDV|8210718|Tor 0.4.7.12|Clark Gaebel <destiny.lent.0b _ icloud.com>
100.33.127.76|helmholtz2|9001|0|FGHRSDV|1040418|Tor 0.4.7.13|<vigilantfinch AT proton dot me>
101.100.139.201|unlimitedrelay085|9001|0|FHRSDV|1101724|Tor 0.4.8.0-alpha-dev|relay@lsl-network.com
```

## Déterminer les techniques malveillantes utilisées par le Malware

Pour cette partie, nous nous sommes grandement appuyés sur le site référence <a href="[https://attack.mitre.org/](https://attack.mitre.org/)">MITRE ATT&CK</a>.

Ce site répertorie entre autres toutes les catégories, techniques et sous techniques malveillantes destinées à nuire à nos machines.

Nous l'avons dans un premier temps étudié, en particulier sa <a href="[https://attack.mitre.org/matrices/enterprise/](https://attack.mitre.org/matrices/enterprise/)"> Matrice entreprise</a>.

Ensuite, nous avons croisé et correlé les données issues du gestionnaire d’événements Windows avec celles de MITRE ATT&CK pour déterminer si un programme cible avait un comportement pouvant se rapprocher d'une technique malveillante.

Pour cela, nous avons dans un premier temps beaucoup tâtonner. Pour la version finale (<b>parser/AttackDescriptionFetching/MitreAttackParsing.ipynb</b>), nous avons récupéré les liens des techniques avec BeautifulSoup. Le nombre de techniques sur MITRE ATT&CK étant de l'ordre du millier, interroger continuellement le site pour chaque Event ID (Identifiant d'un événement Windows) était une tâche trop chronophage.

Nous avons donc opté pour une base de données SQL servant d'index. Ainsi, en interrogeant la base de données pour un Event ID particulier, celle-ci renvoie les liens de techniques l'utilisant référencée, par MITRE ATT&CK.

Pour les de besoins l’extacteur, nous avons exporté le contenu de cette base de données sous forme de fichier CSV.

## Fonctions & DLL’s chargées par le processus + Documentation

Afin de récupérer les fonctions et DLL’s utilisées par le processus analysé, on récupère les données de la table d’exportations de l’entête PE (Section des entêtes optionnelles), on élague les données et on rassemble le tout dans un format XML qui sera ensuite traité par un bloc de code qui se chargera de récupérer le lien vers la documentation Microsoft à l’aide d’un parsing dynamique.

```xml
		<Title>
						OpenTraceW, fonction (evntrace.h) - Win32 apps
		</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-opentracew</Link>
		</ResolvedFunction>
<ResolvedFunction>
		<Title>
				EnableTrace, fonction (evntrace.h) - Win32 apps
			</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-enabletrace</Link>
	</ResolvedFunction>
	<ResolvedFunction>
		<Title>
				ControlTraceW, fonction (evntrace.h) - Win32 apps
			</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-controltracew</Link>
	</ResolvedFunction>
	<ResolvedFunction>
```

## Interface Frontend de visualisation des résultats

Nous avons également réalisé une interface Frontend à l’aide d’Angular qui permet de visualiser graphiquement les résultats du fichier XML final. 

<b>On upload le fichier XML : <b><br><br>
<img width="40%" src="https://i.ibb.co/09LZLgR/image.png">
<br><br>
<b>Let's rock :</b><br><br>
<img width="80%" src="https://i.ibb.co/bg3qfSp/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/6R9bQ7X/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/3y1MF9h/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/g61W7y3/image.png">
<br><br>
<img src="https://i.ibb.co/PCZDnn2/image.png">

## Statistiques

Nous mettons également à disposition un notebook fait sur Google Collab permettant de visualiser quelques statistiques sur un XML chargé :

<img width="70%" src="https://i.ibb.co/qm8sr7B/image.png">
<br><br>
<img src="https://i.ibb.co/NNHHcsk/image.png">
<br><br>
<img src="https://i.ibb.co/5v9g3QC/image.png">
<br><br>
<img src="https://i.ibb.co/C5PMN8N/image.png">
<br><br>
<img src="https://i.ibb.co/C80SmcT/image.png">
<br><br>
<img src="https://i.ibb.co/rb5Q4xd/image.png">






# Data Engineering Project : Malwares Data Analysis

<img width="20%" src="https://www.univ-rennes.fr/sites/www.univ-rennes.fr/files/styles/max_2600x2600/public/medias/images/UNIRENNES_LOGOnoir_0.png?itok=foBK77XJ">
<img width="18%" src="https://esir.univ-rennes.fr/sites/esir.univ-rennes.fr/files/esir.png">
  
## Introduction

Throughout this project, we have applied the skills acquired in our DE (Data Engineering) course to design a project that can address a specific issue: malware analysis (on Windows) and the visualization of their behavior.

The main technologies used are as follows :

| Name | Logo |
| --- | --- |
| Pandas | <img src="assets/img/pandas.png" width="30%" alt="Pandas logo"> |
| BeautifulSoup | <img src="assets/img/beautifulSoup.png" alt="BeautifulSoup logo" width="30%" > |
| Selenium | <img src="assets/img/selenium.jpg" alt="Selenium logo" width="30%" > |

The tool we have developed enables us to:

<ul>
	<li>Geolocate the IP addresses with which a malware communicates and determine if they go through the TOR network.
</li>
	<li>Determine the techniques employed by the malware.
</li>
	<li>Visualize the functions and DLLs loaded by the malware.
</li>
	<li>Visualize the malware's antivirus detection rate.
</li>
	<li>And much more...!
</li>
</ul>
	
General operational diagram :

<img width="50%" src="https://i.ibb.co/V2Pqxwz/Diagramme-vierge-8.png">

Diagrams of the data extraction and treatment process :

<img src="https://i.ibb.co/mSQcHP5/Diagramme-Projet-DE-1.png" alt="extraction process diagram">

<img src="https://i.ibb.co/jh2S0d6/schema-idee-projet-2-1.png" alt="data collection scheme">

## Video showing the process of extracting, parsing and collecting data on a Windows process (Showing Selenium drivers when parsing Microsoft.com and geolocation.io)

[![Extractor & parsing in action](https://img.youtube.com/vi/QagDy882Ak0/0.jpg)](https://www.youtube.com/watch?v=QagDy882Ak0)

## Retrieving Antivirus detection information

In order to be able to know which antiviruses detect our process as malicious or not, we use the VirusTotal API to which we make a request with the process in question and, which after a processing time, returns a series of data including a hash identifying the signature of the process and the link to the detection information concerning this process. It is this returned link that we query afterwards in order to parse and obtain the names of antivirus editors and their detection status.

We also found a nice little API that returns the logo of a company if it finds its website.
```xml
<SecurityVendors>
	<Vendor>
		<Logo>https://api.kickfire.com/logo?website=Google.com</Logo>
		<Name>Google</Name>
		<Detected>No</Detected>
		<Update>20230517</Update>
	</Vendor>
	<Vendor>
		<Logo>https://api.kickfire.com/logo?website=APEX.com</Logo>
		<Name>APEX</Name>
		<Detected>Yes</Detected>
		<Update>20230516</Update>
	</Vendor>
```

## Retrieval and geolocation of contacted IP addresses

The extactor is in charge of launching a capture of IP packets on the processes and collects them until reaching a scalable threshold of packets. It formats the captured packets in a CSV file that will then be used by the code block responsible for the dynamic parsing of the IP geolocation site [https://ipgeolocation.io/] to which it sends the destination IP addresses one by one and retrieves the geolocation data (latitude, longitude, country, ISP).

Part of PacketCaptureDump.csv (generated at the end of the capture): 
```csv
time,ip_version,src_ip,src_port,dst_ip,dst_port,ip_ttl,proto,ip_flags
12:48:15,4,192.168.1.22,35601,162.250.191.15,7777,128,6,0x40
12:48:15,4,192.168.1.22,35600,162.250.191.15,7777,128,6,0x40
12:48:15,4,192.168.1.22,35599,162.212.158.82,7777,128,6,0x40
```

## Determination of a connection to the TOR network

For this second part, we had to study a <a href="[https://www.dan.me.uk/tornodes](https://www.dan.me.uk/tornodes)"> site referencing TOR network nodes.</a>

Please note that the site administrator only allows one connection every 30 minutes.

After its study, we proceeded to its scrapping thanks to BeautifulSoup. Once done, we centralized all TOR network nodes within a CSV file (<b>parser/GettingDarkWebIPs/dark_IPv4_addresses.csv</b>), more manageable for future use.

Extrait d'un snapshot des noeuds d'entr√©e TOR datant du 05/05/23:

```csv
1.33.33.5|5gnPr4VhxQm2zHcHQcm|443|0|FRDV|280448|Tor 0.4.7.13|Random Person <nobody AT example dot com>
100.19.145.164|TBB|443|0|FRDV|63|Tor 0.4.7.13|
100.2.45.164|hubble|9001|0|FGHRSDV|8210718|Tor 0.4.7.12|Clark Gaebel <destiny.lent.0b _ icloud.com>
100.33.127.76|helmholtz2|9001|0|FGHRSDV|1040418|Tor 0.4.7.13|<vigilantfinch AT proton dot me>
101.100.139.201|unlimitedrelay085|9001|0|FHRSDV|1101724|Tor 0.4.8.0-alpha-dev|relay@lsl-network.com
```

## Identification of the malicious techniques used by the malware

For this part, we relied heavily on the reference site <a href="[https://attack.mitre.org/](https://attack.mitre.org/)">MITRE ATT&CK</a>.

This framework and the website it provides, lists all the malicious categories, techniques and sub-techniques intended to harm a target.

We initially studied it, in particular its <a href="[https://attack.mitre.org/matrices/enterprise/](https://attack.mitre.org/matrices/enterprise/)"> Enterprise Matrix</a>.

Next, we cross-referenced and correlated data from the Windows event manager with data from MITRE ATT&CK to determine if a targeted program exhibited behavior that could approximate a malicious technique.

To do this, we first had to do a lot of experimenting. For the final version (<b>parser/AttackDescriptionFetching/MitreAttackParsing.ipynb</b>), we have retrieved the links of the techniques with BeautifulSoup. With the number of techniques on MITRE ATT&CK in the thousands, continually querying the site for each Windows Event ID was too time consuming.

We therefore opted for a SQL database as an index. Thus, when querying the database for a particular Event ID, it returns the links of techniques using it referenced, by MITRE ATT&CK.

For the needs of the extactor, we have exported the content of this database as a CSV file.

##  Functions & DLL's loaded by the process + Documentation

In order to retrieve the functions and DLL's used by the analyzed process, we retrieve the data from the export table of the PE header (Optional Headers Section), we prune the data and we put it all together in an XML format that will then be processed by a code block that will retrieve the link to the Microsoft documentation using dynamic parsing.


<img src="https://i.ibb.co/7QmPHVS/image.png">

```xml
		<Title>
						OpenTraceW, fonction (evntrace.h) - Win32 apps
		</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-opentracew</Link>
		</ResolvedFunction>
<ResolvedFunction>
		<Title>
				EnableTrace, fonction (evntrace.h) - Win32 apps
			</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-enabletrace</Link>
	</ResolvedFunction>
	<ResolvedFunction>
		<Title>
				ControlTraceW, fonction (evntrace.h) - Win32 apps
			</Title>
		<Link>https://learn.microsoft.com/fr-fr/windows/win32/api/evntrace/nf-evntrace-controltracew</Link>
	</ResolvedFunction>
	<ResolvedFunction>
```

## Frontend interface for results visualisation

We also created a frontend interface using Angular that allows you to graphically view the results of the final XML file. 

<b> We first upload the XML file: <b><br><br>
<img width="40%" src="https://i.ibb.co/09LZLgR/image.png">
<br><br>
<b>Let's rock :</b><br><br>
<img width="80%" src="https://i.ibb.co/bg3qfSp/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/6R9bQ7X/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/3y1MF9h/image.png">
<br><br>
<img width="80%" src="https://i.ibb.co/g61W7y3/image.png">
<br><br>
<img src="https://i.ibb.co/PCZDnn2/image.png">

## Statistiques

We also provide a notebook made on Google Collab allowing to visualize some statistics on a loaded XML:

<img width="70%" src="https://i.ibb.co/qm8sr7B/image.png">
<br><br>
<img src="https://i.ibb.co/NNHHcsk/image.png">
<br><br>
<img src="https://i.ibb.co/5v9g3QC/image.png">
<br><br>
<img src="https://i.ibb.co/C5PMN8N/image.png">
<br><br>
<img src="https://i.ibb.co/C80SmcT/image.png">
<br><br>
<img src="https://i.ibb.co/rb5Q4xd/image.png">





